<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototipo: Gestión de Incapacidades</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop, .sidebar-backdrop {
            transition: opacity 0.3s ease;
        }
        .modal-content, .sidebar-content {
            transition: transform 0.3s ease;
        }
        .error-message {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
        .search-results {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-300">

    <!-- Main Content -->
    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-white">Cálculo de Incapacidades</h1>
            <p class="text-gray-400">Cliente: Soluciones Tech Global S.A. de C.V.</p>
        </header>

        <!-- Incapacidades Section -->
        <div id="incapacidades-section" class="bg-gray-800 p-6 rounded-lg shadow-lg">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-semibold text-white">Listado de Incapacidades</h2>
                <div class="flex flex-wrap gap-2">
                     <button id="downloadReportBtn" class="bg-green-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300 shadow-sm flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Descargar Reporte
                    </button>
                     <button id="openImportSidebarBtn" class="bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition duration-300 shadow-sm flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        Importar
                    </button>
                    <button id="openModalBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-sm flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Registrar Incapacidad
                    </button>
                </div>
            </div>

            <!-- Filters -->
            <div class="mb-6 p-4 bg-gray-700/50 rounded-lg">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                    <div class="lg:col-span-2">
                        <label for="searchInput" class="block text-sm font-medium text-gray-400 mb-1">Búsqueda Rápida</label>
                        <input type="text" id="searchInput" class="block w-full pl-3 pr-3 py-2 border border-gray-600 rounded-md bg-gray-800 text-white placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Nombre, RFC, NSS...">
                    </div>
                    <div>
                        <label for="filterStartDate" class="block text-sm font-medium text-gray-400 mb-1">Fecha Inicio</label>
                        <input type="date" id="filterStartDate" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-800 text-white">
                    </div>
                     <div>
                        <label for="filterEndDate" class="block text-sm font-medium text-gray-400 mb-1">Fecha Fin</label>
                        <input type="date" id="filterEndDate" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-800 text-white">
                    </div>
                    <div>
                        <label for="filterTipo" class="block text-sm font-medium text-gray-400 mb-1">Tipo</label>
                        <select id="filterTipo" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-800 text-white">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterModo" class="block text-sm font-medium text-gray-400 mb-1">Modo</label>
                        <select id="filterModo" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-800 text-white">
                            <option value="">Todos</option>
                        </select>
                    </div>
                     <div>
                        <label for="filterEstado" class="block text-sm font-medium text-gray-400 mb-1">Estado</label>
                        <select id="filterEstado" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-800 text-white">
                            <option value="">Todos</option>
                            <option value="Activa">Activa</option>
                            <option value="Terminada">Terminada</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button id="clearFiltersBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition">Limpiar</button>
                    <button id="applyFiltersBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Aplicar Filtros</button>
                </div>
            </div>

            <!-- Lista de Incapacidades -->
            <div class="overflow-x-auto">
                <table id="incapacidadesTable" class="min-w-full">
                    <thead class="bg-gray-700">
                        <tr>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Trabajador (RFC/NSS)</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Folio</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Tipo</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Inicio</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Fin</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Días</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Modo</th>
                            <th class="text-left py-3 px-4 uppercase font-semibold text-sm text-white">Estado</th>
                        </tr>
                    </thead>
                    <tbody class="text-gray-300">
                        <!-- Rows will be added dynamically -->
                    </tbody>
                </table>
                 <p id="noResults" class="text-center text-gray-500 py-8 hidden">No se encontraron incapacidades que coincidan con los filtros.</p>
            </div>
            <!-- Pagination -->
            <div id="paginationControls" class="flex flex-col md:flex-row justify-between items-center mt-6 text-sm">
                <div class="flex items-center mb-4 md:mb-0">
                    <span class="mr-2">Filas por página:</span>
                    <select id="rowsPerPage" class="p-1 border border-gray-600 rounded-md bg-gray-800 text-white">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                    </select>
                </div>
                <div id="paginationInfo" class="mb-4 md:mb-0"></div>
                <div class="flex items-center">
                    <button id="prevPageBtn" class="bg-gray-600 p-2 rounded-md hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <span id="pageIndicator" class="px-4"></span>
                    <button id="nextPageBtn" class="bg-gray-600 p-2 rounded-md hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Registro -->
    <div id="incapacidadModal" class="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-gray-800 border border-gray-700 rounded-xl shadow-2xl w-full max-w-2xl modal-content transform scale-95">
            <div class="flex justify-between items-center p-5 border-b border-gray-700">
                <h3 class="text-xl font-semibold text-white">Registrar Incapacidad</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="incapacidadForm" class="p-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label for="trabajadorSearch" class="block text-sm font-medium text-gray-400 mb-1">Buscar Trabajador*</label>
                        <input type="text" id="trabajadorSearch" name="trabajadorSearch" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900 text-white" placeholder="Escribe para buscar..." autocomplete="off" required>
                        <input type="hidden" id="trabajadorId" name="trabajadorId">
                        <div id="trabajadorSearchResults" class="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded-md mt-1 hidden search-results"></div>
                    </div>
                    <div>
                        <label for="numeroIncapacidad" class="block text-sm font-medium text-gray-400 mb-1">Número de Incapacidad (Folio)*</label>
                        <input type="text" id="numeroIncapacidad" name="numeroIncapacidad" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900" placeholder="Ej: AB123456" pattern="[A-Za-z]{2}[0-9]{6}" required>
                         <p id="folioError" class="text-red-500 text-xs mt-1 hidden">Formato incorrecto. Deben ser 2 letras y 6 números.</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tipoIncapacidad" class="block text-sm font-medium text-gray-400 mb-1">Tipo de Incapacidad IMSS*</label>
                        <select id="tipoIncapacidad" name="tipoIncapacidad" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900">
                            <option value="Enfermedad General">Enfermedad General</option>
                            <option value="Maternidad">Maternidad</option>
                            <option value="Riesgo de Trabajo">Riesgo de Trabajo</option>
                        </select>
                    </div>
                    <div id="subtipoContainer" class="hidden">
                        <label for="subtipoRiesgo" class="block text-sm font-medium text-gray-400 mb-1">Subtipo de Riesgo*</label>
                        <select id="subtipoRiesgo" name="subtipoRiesgo" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900">
                            <option value="Accidente de Trabajo">Accidente de Trabajo</option>
                            <option value="Accidente en Trayecto">Accidente en Trayecto</option>
                            <option value="Enfermedad de Trabajo">Enfermedad de Trabajo</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label for="fechaInicio" class="block text-sm font-medium text-gray-400 mb-1">Fecha de Inicio*</label>
                        <input type="date" id="fechaInicio" name="fechaInicio" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900" required>
                    </div>
                    <div>
                        <label for="diasIncapacidad" class="block text-sm font-medium text-gray-400 mb-1">Días*</label>
                        <input type="number" id="diasIncapacidad" name="diasIncapacidad" min="1" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900" required>
                    </div>
                    <div>
                        <label for="fechaTermino" class="block text-sm font-medium text-gray-400 mb-1">Fecha de Término</label>
                        <input type="date" id="fechaTermino" name="fechaTermino" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-700" readonly>
                    </div>
                    <div>
                        <label for="fechaExpedicion" class="block text-sm font-medium text-gray-400 mb-1">Fecha Expedición</label>
                        <input type="date" id="fechaExpedicion" name="fechaExpedicion" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900">
                    </div>
                </div>
                <div>
                    <label for="modoIncapacidad" class="block text-sm font-medium text-gray-400 mb-1">Modo de Incapacidad*</label>
                    <select id="modoIncapacidad" name="modoIncapacidad" class="w-full p-2 border border-gray-600 rounded-md shadow-sm bg-gray-900" required>
                        <option value="Inicial">Inicial</option>
                        <option value="Subsecuente">Subsecuente</option>
                        <option value="Unica">Única</option>
                    </select>
                    <p id="modoError" class="text-red-500 text-xs mt-1 hidden error-message"></p>
                </div>

                <!-- Payroll Overlap Warning -->
                <div id="payrollWarning" class="hidden p-3 text-sm text-yellow-300 bg-yellow-900/50 rounded-lg" role="alert">
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        <span class="font-medium">¡Advertencia!</span>
                    </div>
                    <div class="mt-1 ml-7 text-yellow-400">
                        El rango de fechas se cruza con un periodo de nómina ya autorizado.
                    </div>
                </div>

                <div class="flex justify-end items-center pt-4 border-t border-gray-700">
                    <button type="button" id="cancelBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition mr-2">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">Guardar Incapacidad</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Sidebar de Importación -->
    <div id="importSidebar" class="fixed inset-0 z-40 sidebar-backdrop opacity-0 pointer-events-none">
        <div id="sidebarContent" class="fixed top-0 right-0 h-full w-full max-w-md bg-gray-800 border-l border-gray-700 shadow-2xl sidebar-content transform translate-x-full">
            <div class="flex flex-col h-full">
                <div class="flex justify-between items-center p-5 border-b border-gray-700">
                    <h3 class="text-xl font-semibold text-white">Carga masiva de incidencias</h3>
                    <button id="closeImportSidebarBtn" class="text-gray-400 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="p-6 space-y-6 flex-grow">
                    <div>
                        <h4 class="text-lg font-medium text-white">1.- Descarga el template</h4>
                        <p class="text-gray-400 text-sm mb-2">Descarga el template para llenar los datos de las incidencias.</p>
                        <button class="w-full bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition">Descargar template</button>
                    </div>
                     <div>
                        <h4 class="text-lg font-medium text-white">2.- Sube el archivo</h4>
                        <p class="text-gray-400 text-sm mb-2">Sube el archivo con los datos de las incidencias.</p>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-md">
                            <div class="space-y-1 text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <div class="flex text-sm text-gray-400">
                                    <label for="file-upload" class="relative cursor-pointer bg-gray-800 rounded-md font-medium text-blue-400 hover:text-blue-500 focus-within:outline-none">
                                        <span>Subir archivo</span>
                                        <input id="file-upload" name="file-upload" type="file" class="sr-only">
                                    </label>
                                    <p class="pl-1">o arrástralo aquí</p>
                                </div>
                                <p class="text-xs text-gray-500">XLS, XLSX hasta 10MB</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-gray-700">
                    <button class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition">Guardar</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA MOCK ---
            const trabajadores = [
                { id: 1, nombre: 'María Pérez', rfc: 'PEPM900101ABC', nss: '12345678901' },
                { id: 2, nombre: 'Juan Rodríguez', rfc: 'RODJ850202DEF', nss: '09876543211' },
                { id: 3, nombre: 'Ana García', rfc: 'GAMA880303GHI', nss: '11223344551' },
                { id: 4, nombre: 'Carlos Sánchez', rfc: 'SACJ920404JKL', nss: '22334455661' },
                { id: 5, nombre: 'Laura Martínez', rfc: 'MALF950505MNO', nss: '33445566771' },
                { id: 6, nombre: 'Pedro Gómez', rfc: 'GOGP800606PQR', nss: '44556677881' },
                { id: 7, nombre: 'Sofía Hernández', rfc: 'HESJ980707STU', nss: '55667788991' },
                { id: 8, nombre: 'Luis Torres', rfc: 'TOLJ750808VWX', nss: '66778899001' },
                { id: 9, nombre: 'Gabriela Díaz', rfc: 'DIAG890909YZA', nss: '77889900111' },
                { id: 10, nombre: 'Jorge Ramírez', rfc: 'RAJG911010BCD', nss: '88990011221' },
                { id: 11, nombre: 'Fernanda Cruz', rfc: 'CRUF931111EFG', nss: '99001122331' }
            ];

            let incapacidades = [
                { id: 1, trabajadorId: 1, trabajadorNombre: 'María Pérez', rfc: 'PEPM900101ABC', nss: '12345678901', folio: 'IF250710', tipo: 'Enfermedad General', subtipo: null, fechaInicio: '2025-07-10', dias: 5, fechaTermino: '2025-07-14', modo: 'Inicial' },
                { id: 2, trabajadorId: 1, trabajadorNombre: 'María Pérez', rfc: 'PEPM900101ABC', nss: '12345678901', folio: 'IF250715', tipo: 'Enfermedad General', subtipo: null, fechaInicio: '2025-07-15', dias: 3, fechaTermino: '2025-07-17', modo: 'Subsecuente' },
                { id: 3, trabajadorId: 2, trabajadorNombre: 'Juan Rodríguez', rfc: 'RODJ850202DEF', nss: '09876543211', folio: 'GE250707', tipo: 'Enfermedad General', subtipo: null, fechaInicio: '2025-07-07', dias: 3, fechaTermino: '2025-07-09', modo: 'Unica' },
                { id: 4, trabajadorId: 3, trabajadorNombre: 'Ana García', rfc: 'GAMA880303GHI', nss: '11223344551', folio: 'MA250601', tipo: 'Maternidad', subtipo: null, fechaInicio: '2025-06-01', dias: 84, fechaTermino: '2025-08-23', modo: 'Unica' },
                { id: 5, trabajadorId: 2, trabajadorNombre: 'Juan Rodríguez', rfc: 'RODJ850202DEF', nss: '09876543211', folio: 'RT250520', tipo: 'Riesgo de Trabajo', subtipo: 'Accidente de Trabajo', fechaInicio: '2025-05-20', dias: 10, fechaTermino: '2025-05-29', modo: 'Inicial' },
                ...Array.from({ length: 15 }, (_, i) => ({
                    id: 6 + i,
                    trabajadorId: (i % 11) + 1,
                    trabajadorNombre: trabajadores[i % 11].nombre,
                    rfc: trabajadores[i % 11].rfc,
                    nss: trabajadores[i % 11].nss,
                    folio: `EG${250401 + i}`,
                    tipo: 'Enfermedad General',
                    subtipo: null,
                    fechaInicio: `2025-04-${(i % 28) + 1}`,
                    dias: (i % 5) + 1,
                    fechaTermino: `2025-04-${(i % 28) + 1 + (i % 5)}`,
                    modo: 'Inicial'
                }))
            ];
            
            const periodosAutorizados = [
                { start: '2025-07-01', end: '2025-07-07' }
            ];

            // --- STATE ---
            let currentPage = 1;
            let rowsPerPage = 10;
            let filteredIncapacidades = [];

            // --- UI ELEMENTS ---
            const openModalBtn = document.getElementById('openModalBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const modal = document.getElementById('incapacidadModal');
            const form = document.getElementById('incapacidadForm');
            const tableBody = document.getElementById('incapacidadesTable').querySelector('tbody');
            const trabajadorSearchInput = document.getElementById('trabajadorSearch');
            const trabajadorIdInput = document.getElementById('trabajadorId');
            const trabajadorSearchResults = document.getElementById('trabajadorSearchResults');
            const tipoIncapacidadSelect = document.getElementById('tipoIncapacidad');
            const subtipoContainer = document.getElementById('subtipoContainer');
            const fechaInicioInput = document.getElementById('fechaInicio');
            const diasInput = document.getElementById('diasIncapacidad');
            const fechaTerminoInput = document.getElementById('fechaTermino');
            const folioInput = document.getElementById('numeroIncapacidad');
            const folioError = document.getElementById('folioError');
            const modoSelect = document.getElementById('modoIncapacidad');
            const modoError = document.getElementById('modoError');
            const payrollWarning = document.getElementById('payrollWarning');
            const noResultsP = document.getElementById('noResults');
            const downloadReportBtn = document.getElementById('downloadReportBtn');

            // Filter elements
            const searchInput = document.getElementById('searchInput');
            const filterStartDate = document.getElementById('filterStartDate');
            const filterEndDate = document.getElementById('filterEndDate');
            const filterTipo = document.getElementById('filterTipo');
            const filterModo = document.getElementById('filterModo');
            const filterEstado = document.getElementById('filterEstado');
            const applyFiltersBtn = document.getElementById('applyFiltersBtn');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');

            // Pagination elements
            const paginationControls = document.getElementById('paginationControls');
            const rowsPerPageSelect = document.getElementById('rowsPerPage');
            const paginationInfo = document.getElementById('paginationInfo');
            const pageIndicator = document.getElementById('pageIndicator');
            const prevPageBtn = document.getElementById('prevPageBtn');
            const nextPageBtn = document.getElementById('nextPageBtn');

            // Import Sidebar elements
            const openImportSidebarBtn = document.getElementById('openImportSidebarBtn');
            const closeImportSidebarBtn = document.getElementById('closeImportSidebarBtn');
            const importSidebar = document.getElementById('importSidebar');
            const sidebarContent = document.getElementById('sidebarContent');

            // --- FUNCTIONS ---
            const toggleModal = (show) => {
                if (show) {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                } else {
                    modal.classList.add('opacity-0');
                    setTimeout(() => {
                        modal.classList.add('pointer-events-none');
                        modal.querySelector('.modal-content').classList.add('scale-95');
                    }, 300);
                }
            };
            
            const toggleSidebar = (show) => {
                if (show) {
                    importSidebar.classList.remove('opacity-0', 'pointer-events-none');
                    sidebarContent.classList.remove('translate-x-full');
                } else {
                    sidebarContent.classList.add('translate-x-full');
                    setTimeout(() => {
                        importSidebar.classList.add('opacity-0', 'pointer-events-none');
                    }, 300);
                }
            };

            const formatDate = (dateString, separator = '/') => {
                if (!dateString) return '';
                const date = new Date(dateString + 'T00:00:00');
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return [day, month, year].join(separator);
            };

            const applyFiltersAndRender = () => {
                const filters = {
                    search: searchInput.value.toLowerCase().trim(),
                    startDate: filterStartDate.value,
                    endDate: filterEndDate.value,
                    tipo: filterTipo.value,
                    modo: filterModo.value,
                    estado: filterEstado.value
                };

                filteredIncapacidades = incapacidades.filter(inc => {
                    const searchMatch = filters.search === '' ||
                        inc.trabajadorNombre.toLowerCase().includes(filters.search) ||
                        inc.rfc.toLowerCase().includes(filters.search) ||
                        inc.nss.toLowerCase().includes(filters.search);
                    const incDate = new Date(inc.fechaInicio);
                    const startDateMatch = !filters.startDate || incDate >= new Date(filters.startDate);
                    const endDateMatch = !filters.endDate || incDate <= new Date(filters.endDate);
                    const tipoMatch = !filters.tipo || inc.tipo === filters.tipo;
                    const modoMatch = !filters.modo || inc.modo === filters.modo;
                    const hoy = new Date();
                    const fin = new Date(inc.fechaTermino + 'T23:59:59');
                    const estadoActual = hoy <= fin ? 'Activa' : 'Terminada';
                    const estadoMatch = !filters.estado || estadoActual === filters.estado;
                    return searchMatch && startDateMatch && endDateMatch && tipoMatch && modoMatch && estadoMatch;
                }).sort((a, b) => new Date(b.fechaInicio) - new Date(a.fechaInicio));
                
                currentPage = 1;
                renderPage();
            };

            const renderPage = () => {
                tableBody.innerHTML = '';
                noResultsP.classList.toggle('hidden', filteredIncapacidades.length > 0);
                paginationControls.classList.toggle('hidden', filteredIncapacidades.length === 0);

                if (filteredIncapacidades.length === 0) return;

                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = startIndex + rowsPerPage;
                const pageItems = filteredIncapacidades.slice(startIndex, endIndex);

                pageItems.forEach(inc => {
                    const hoy = new Date();
                    const fin = new Date(inc.fechaTermino + 'T23:59:59');
                    const estado = hoy <= fin ?
                        '<span class="bg-green-900 text-green-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Activa</span>' :
                        '<span class="bg-red-900 text-red-300 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Terminada</span>';

                    const row = `
                        <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                            <td class="py-3 px-4">
                                <div class="font-medium text-white">${inc.trabajadorNombre}</div>
                                <div class="text-xs text-gray-400">${inc.rfc} / ${inc.nss}</div>
                            </td>
                            <td class="py-3 px-4 font-mono">${inc.folio}</td>
                            <td class="py-3 px-4">${inc.subtipo ? `${inc.tipo} (${inc.subtipo})` : inc.tipo}</td>
                            <td class="py-3 px-4">${formatDate(inc.fechaInicio)}</td>
                            <td class="py-3 px-4">${formatDate(inc.fechaTermino)}</td>
                            <td class="py-3 px-4 text-center">${inc.dias}</td>
                            <td class="py-3 px-4">${inc.modo}</td>
                            <td class="py-3 px-4">${estado}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
                renderPaginationControls();
            };

            const renderPaginationControls = () => {
                const totalItems = filteredIncapacidades.length;
                const totalPages = Math.ceil(totalItems / rowsPerPage);
                
                const startItem = totalItems > 0 ? (currentPage - 1) * rowsPerPage + 1 : 0;
                const endItem = Math.min(currentPage * rowsPerPage, totalItems);

                paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${totalItems} registros`;
                pageIndicator.textContent = `Página ${currentPage} de ${totalPages}`;

                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
            };
            
            const populateSelects = () => {
                const tipos = [...new Set(incapacidades.map(i => i.tipo))];
                tipos.forEach(t => filterTipo.innerHTML += `<option value="${t}">${t}</option>`);
                const modos = [...new Set(incapacidades.map(i => i.modo))];
                modos.forEach(m => filterModo.innerHTML += `<option value="${m}">${m}</option>`);
            };

            const calcularFechaTermino = () => {
                const fechaInicio = fechaInicioInput.value;
                const dias = parseInt(diasInput.value, 10);
                if (fechaInicio && dias > 0) {
                    const fecha = new Date(fechaInicio + 'T00:00:00');
                    fecha.setDate(fecha.getDate() + dias - 1);
                    fechaTerminoInput.value = fecha.toISOString().split('T')[0];
                } else {
                    fechaTerminoInput.value = '';
                }
                validatePayrollOverlap();
            };
            
            const validatePayrollOverlap = () => {
                const newStartStr = fechaInicioInput.value;
                const newEndStr = fechaTerminoInput.value;

                if (!newStartStr || !newEndStr) {
                    payrollWarning.classList.add('hidden');
                    return;
                }

                const newStart = new Date(newStartStr);
                const newEnd = new Date(newEndStr);

                const hasOverlap = periodosAutorizados.some(periodo => {
                    const authStart = new Date(periodo.start);
                    const authEnd = new Date(periodo.end);
                    return newStart <= authEnd && newEnd >= authStart;
                });

                payrollWarning.classList.toggle('hidden', !hasOverlap);
            };
            
            const validarModo = () => {
                const trabajadorId = parseInt(trabajadorIdInput.value, 10);
                const modo = modoSelect.value;
                const fechaInicioNuevaStr = fechaInicioInput.value;
                modoError.classList.add('hidden');
                if (modo !== 'Subsecuente' || !trabajadorId || !fechaInicioNuevaStr) return true;
                const incapacidadesTrabajador = incapacidades.filter(i => i.trabajadorId === trabajadorId).sort((a, b) => new Date(b.fechaTermino) - new Date(a.fechaTermino));
                if (incapacidadesTrabajador.length === 0) {
                     modoError.textContent = 'Error: No existe una incapacidad inicial para este trabajador.';
                     modoError.classList.remove('hidden');
                     return false;
                }
                const ultimaIncapacidad = incapacidadesTrabajador[0];
                if (ultimaIncapacidad.modo === 'Unica') {
                    modoError.textContent = `Error: La última incapacidad (${ultimaIncapacidad.folio}) fue 'Única'.`;
                    modoError.classList.remove('hidden');
                    return false;
                }
                const fechaTerminoAnterior = new Date(ultimaIncapacidad.fechaTermino + 'T00:00:00');
                const fechaSiguienteEsperada = new Date(fechaTerminoAnterior);
                fechaSiguienteEsperada.setDate(fechaSiguienteEsperada.getDate() + 1);
                const fechaInicioNueva = new Date(fechaInicioNuevaStr + 'T00:00:00');
                if (fechaInicioNueva.getTime() !== fechaSiguienteEsperada.getTime()) {
                    modoError.textContent = `Error: La fecha de inicio debe ser ${formatDate(fechaSiguienteEsperada.toISOString().split('T')[0])}.`;
                    modoError.classList.remove('hidden');
                    return false;
                }
                return true;
            };

            const downloadSUAReport = () => {
                if (filteredIncapacidades.length === 0) {
                    alert('No hay datos para exportar. Por favor, ajuste los filtros.');
                    return;
                }

                const headers = [
                    'NSS',
                    'Folio',
                    'TipoIncapacidad',
                    'Dias',
                    'FechaInicio'
                ];

                // SUA Tipo Incapacidad codes (example)
                const tipoSUACodes = {
                    'Enfermedad General': '1',
                    'Riesgo de Trabajo': '2',
                    'Maternidad': '3'
                };

                const csvContent = [
                    headers.join(','),
                    ...filteredIncapacidades.map(inc => [
                        inc.nss,
                        inc.folio,
                        tipoSUACodes[inc.tipo] || '0', // Default a 0 si no se encuentra
                        inc.dias,
                        formatDate(inc.fechaInicio)
                    ].join(','))
                ].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', 'Reporte_SUA_Incapacidades.csv');
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            // --- EVENT LISTENERS ---
            openModalBtn.addEventListener('click', () => {
                form.reset();
                trabajadorIdInput.value = '';
                payrollWarning.classList.add('hidden');
                modoError.classList.add('hidden');
                folioError.classList.add('hidden');
                toggleModal(true);
            });
            closeModalBtn.addEventListener('click', () => toggleModal(false));
            cancelBtn.addEventListener('click', () => toggleModal(false));
            modal.addEventListener('click', (e) => e.target === modal && toggleModal(false));

            openImportSidebarBtn.addEventListener('click', () => toggleSidebar(true));
            closeImportSidebarBtn.addEventListener('click', () => toggleSidebar(false));
            importSidebar.addEventListener('click', (e) => e.target === importSidebar && toggleSidebar(false));

            downloadReportBtn.addEventListener('click', downloadSUAReport);

            applyFiltersBtn.addEventListener('click', applyFiltersAndRender);
            clearFiltersBtn.addEventListener('click', () => {
                searchInput.value = '';
                filterStartDate.value = '';
                filterEndDate.value = '';
                filterTipo.value = '';
                filterModo.value = '';
                filterEstado.value = '';
                applyFiltersAndRender();
            });

            rowsPerPageSelect.addEventListener('change', (e) => {
                rowsPerPage = parseInt(e.target.value, 10);
                currentPage = 1;
                renderPage();
            });
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderPage();
                }
            });
            nextPageBtn.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredIncapacidades.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPage();
                }
            });

            trabajadorSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length < 2) {
                    trabajadorSearchResults.classList.add('hidden');
                    return;
                }
                const results = trabajadores.filter(t => 
                    t.nombre.toLowerCase().includes(searchTerm) ||
                    t.rfc.toLowerCase().includes(searchTerm) ||
                    t.nss.includes(searchTerm)
                );
                trabajadorSearchResults.innerHTML = '';
                if(results.length > 0) {
                    results.forEach(t => {
                        const div = document.createElement('div');
                        div.className = 'p-2 hover:bg-gray-600 cursor-pointer';
                        div.textContent = `${t.nombre} (${t.rfc})`;
                        div.dataset.id = t.id;
                        div.dataset.nombre = t.nombre;
                        trabajadorSearchResults.appendChild(div);
                    });
                    trabajadorSearchResults.classList.remove('hidden');
                } else {
                    trabajadorSearchResults.classList.add('hidden');
                }
            });

            trabajadorSearchResults.addEventListener('click', (e) => {
                if(e.target.dataset.id) {
                    trabajadorIdInput.value = e.target.dataset.id;
                    trabajadorSearchInput.value = e.target.dataset.nombre;
                    trabajadorSearchResults.classList.add('hidden');
                    validarModo();
                }
            });

            tipoIncapacidadSelect.addEventListener('change', (e) => {
                subtipoContainer.classList.toggle('hidden', e.target.value !== 'Riesgo de Trabajo');
            });

            [fechaInicioInput, diasInput].forEach(el => el.addEventListener('input', calcularFechaTermino));
            folioInput.addEventListener('input', () => folioError.classList.toggle('hidden', folioInput.checkValidity()));
            [modoSelect, fechaInicioInput].forEach(el => el.addEventListener('change', validarModo));

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!trabajadorIdInput.value) {
                    alert('Por favor, seleccione un trabajador de la lista.');
                    return;
                }
                if (!folioInput.checkValidity() || !validarModo()) return;
                const formData = new FormData(form);
                const trabajadorId = parseInt(formData.get('trabajadorId'), 10);
                const trabajador = trabajadores.find(t => t.id === trabajadorId);
                const nuevaIncapacidad = {
                    id: incapacidades.length + 1,
                    trabajadorId,
                    trabajadorNombre: trabajador.nombre,
                    rfc: trabajador.rfc,
                    nss: trabajador.nss,
                    folio: formData.get('numeroIncapacidad').toUpperCase(),
                    tipo: formData.get('tipoIncapacidad'),
                    subtipo: formData.get('tipoIncapacidad') === 'Riesgo de Trabajo' ? formData.get('subtipoRiesgo') : null,
                    fechaInicio: formData.get('fechaInicio'),
                    dias: parseInt(formData.get('diasIncapacidad'), 10),
                    fechaTermino: formData.get('fechaTermino'),
                    modo: formData.get('modoIncapacidad')
                };
                incapacidades.push(nuevaIncapacidad);
                applyFiltersAndRender();
                toggleModal(false);
            });

            // --- INITIALIZATION ---
            populateSelects();
            applyFiltersAndRender();
        });
    </script>
</body>
</html>
